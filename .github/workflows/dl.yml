name: Update data

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: "0 */4 * * *" # Every 4 hours

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      # nba.com doesn't let me use a github actions IP, so route through tailscale
      # https://til.simonwillison.net/tailscale/tailscale-github-actions
      - name: Setup Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:github-actions
          args: "--exit-node-allow-lan-access=true"

      # you can't set the exit-node name at 'up' time; so instead set it after
      # we've gotten up and running
      # https://github.com/tailscale/github-action/issues/123
      # https://github.com/tailscale/tailscale/issues/4152#issuecomment-1066126643
      - name: use named exit node in tailscale
        run: |
          timeout 5m sudo -E tailscale set --exit-node=apple-tv

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Run update
        run: make update
